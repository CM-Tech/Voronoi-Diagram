<html>

    <head>
        <script></script>

        <title>Voronoi diagram</title>
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
        <script type="text/javascript" src="rhill-voronoi-core.min.js"></script>
        <style>
            #c {
                width:100%;
                height:100%;
                background:white;
            }
            body {
                margin:0;
            }
            .chat-input {
                display:absolute;
                position: absolute;
                bottom:calc(50% - 14px);
                left:calc(50% - 100px);
                width:200px;
                border:none;
                border-bottom:solid 1px white;
                border-top:solid 1px white;
                background:none;
                height:30;
                line-height:30px;
                font-size:140%;
                text-align:center;
                color:white;
            }
            #overlay {
                display:absolute;
                position: absolute;
                left: 0px;
                right: 0px;
                top: 0px;
                bottom: 0px;
                z-index: 100;
                display: block;
            }
        </style>
        <script defer=""></script>

        <title>
        </title>

    </head>

    <body>
        <div id="overlay">

        </div>
        <canvas id="c" width="1059" height="662"></canvas>
        <script>
            // JavaScript

            var w = $("body").width();
            var h = $("body").height();
            $("#c").attr("width", $("body").width());

            $("#c").attr("height", $("body").height());
            var c = document.getElementById("c");
            var ctx = c.getContext("2d");
            var particles = [];
            var n = 0;
            var n2 = 0;
            var _d = 0;
            var _dx = 0;
            var _dy = 0;
            var _x = 0;
            var _y = 0;
            var _x1 = 0;
            var _y1 = 0;
            var cpf = 552;
            var mass = 5;
            var friction = 0.01;
            var speed = 0.08;
            var vis = 1;
            var i;
            var j;

            function Particle(x_, y_) {

                this.x = x_;
                this.y = y_;
                this.dx = 0;
                this.dy = 0;
                this.dir=Math.random() * Math.PI*2;

                this.color = Math.random() * 360;
                this.updateLastPos = function() {


                    for (j = 0; j < particles.length; j++) {

                        var part = particles[j];
                        if (part != this) {
                            _x1 = Math.min(part.x - this.x,w-(part.x - this.x));
                            _y1 = Math.min(part.y - this.y,h-(part.y - this.y));
                            _d = mass / (_x1 * _x1 + _y1 * _y1);
                            this.dx -= _x1 * _d;
                            this.dy -= _y1 * _d;
                        }


                    }
                    this.dir+=Math.random()/2-0.25;
                    this.dx=Math.sin(this.dir);
                    this.dy=Math.cos(this.dir);
                    this.x += this.dx*4;
                    this.y += this.dy*4;
                    /*if (this.x < 10) {
                        this.dx = Math.abs(this.dx);
                    }
                    if (this.x > w - 10) {
                        this.dx = -Math.abs(this.dx);
                    }
                    if (this.y < 10) {
                        this.dy = Math.abs(this.dy);
                    }
                    if (this.y > h - 10) {
                        this.dy = -Math.abs(this.dy);
                    }*/
                    this.dy = this.dy * (1 - friction);
                    this.dx = this.dx * (1 - friction);
                    this.x=this.x%w;
                    this.y=this.y%w;

                }
            }
            var VoronoiDemo = {
                voronoi: new Voronoi(),
                diagram: null,
                margin: 0.1,
                canvas: null,
                siteNumber:100,
                bbox: {
                    xl: -w-10,
                    xr: w+w+w+20,
                    yt: -h-10,
                    yb: h+h+h+20
                },
                sites: [],
                timeoutDelay: 100,

                init: function() {
                    this.canvas = document.getElementById('c');
                    this.randomSites(this.siteNumber, true);
                    
                },

                clearSites: function() {
                    this.compute([]);
                },

                randomSites: function(n, clear) {
                    var sites = [];
                    if (!clear) {
                        sites = this.sites.slice(0);
                    }
                    // create vertices
                    var xmargin = this.canvas.width * this.margin,
                        ymargin = this.canvas.height * this.margin,
                        xo = xmargin,
                        dx = this.canvas.width - xmargin * 2,
                        yo = ymargin,
                        dy = this.canvas.height - ymargin * 2;
                    for (var i = 0; i < n; i++) {
                        particles.push(new Particle(
                                self.Math.round((xo + self.Math.random() * dx) * 10) / 10,
                                self.Math.round((yo + self.Math.random() * dy) * 10) / 10));
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x,
                                y: particles[i].y,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x,
                                y: particles[i].y-h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x,
                                y: particles[i].y+h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x+w,
                                y: particles[i].y,
                                color: particles[i].color
                            });
                    }
                    
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y-h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y+h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y-h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x+w,
                                y: particles[i].y+h,
                                color: particles[i].color
                            });
                    }
                    
                    this.compute(sites);
                    // relax sites
                    if (this.timeout) {
                        clearTimeout(this.timeout)
                        this.timeout = null;
                    }
                    var me = this;
                    this.timeout = setTimeout(function() {
                        me.relaxSites();
                    }, this.timeoutDelay);
                },

                relaxSites: function() {
                    if (!this.diagram) {
                        return;
                    }
                    var cells = this.diagram.cells,
                        iCell = cells.length,
                        cell,
                        site, sites = [],
                        again = false,
                        rn, dist;
                   var iCell = particles.length;
                    while (iCell--) {
                        part = particles[iCell];
                        part.updateLastPos();

                        sites.push({
                                x: part.x,
                                y: part.y,
                                color: part.color
                            });

                        //sites.push(site);
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x,
                                y: particles[i].y-h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x,
                                y: particles[i].y+h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x+w,
                                y: particles[i].y,
                                color: particles[i].color
                            });
                    }
                    
                    
                    
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y-h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y+h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x-w,
                                y: particles[i].y-h,
                                color: particles[i].color
                            });
                    }
                    for (var i = 0; i < n; i++) {
                        sites.push({
                                x: particles[i].x+w,
                                y: particles[i].y+h,
                                color: particles[i].color
                            });
                    }
                    this.compute(sites);

                    var me = this;
                    this.timeout = setTimeout(function() {
                        me.relaxSites();
                    }, this.timeoutDelay);

                },

                distance: function(a, b) {
                    var dx = a.x - b.x,
                        dy = a.y - b.y;
                    return Math.sqrt(dx * dx + dy * dy);
                },
                distance2: function(a, b) {
                    var dx = Math.min(a.x - b.x,w-(a.x - b.x));
                        dy = Math.min(a.y - b.y,h-(a.y - b.y));;
                        
                    return Math.sqrt(dx * dx + dy * dy);
                }
,
                cellArea: function(cell) {
                    var area = 0,
                        halfedges = cell.halfedges,
                        iHalfedge = halfedges.length,
                        halfedge,
                        p1, p2;
                    while (iHalfedge--) {
                        halfedge = halfedges[iHalfedge];
                        p1 = halfedge.getStartpoint();
                        p2 = halfedge.getEndpoint();
                        area += p1.x * p2.y;
                        area -= p1.y * p2.x;
                    }
                    area /= 2;
                    return area;
                },

                cellCentroid: function(cell) {
                    var x = 0,
                        y = 0,
                        halfedges = cell.halfedges,
                        iHalfedge = halfedges.length,
                        halfedge,
                        v, p1, p2;
                    while (iHalfedge--) {
                        halfedge = halfedges[iHalfedge];
                        p1 = halfedge.getStartpoint();
                        p2 = halfedge.getEndpoint();
                        v = p1.x * p2.y - p2.x * p1.y;
                        x += (p1.x + p2.x) * v;
                        y += (p1.y + p2.y) * v;
                    }
                    v = this.cellArea(cell) * 6;
                    return {
                        x: x / v,
                        y: y / v
                    };
                },

                compute: function(sites) {
                    this.sites = sites;
                    this.voronoi.recycle(this.diagram);
                    this.diagram = this.voronoi.compute(sites, this.bbox);
                    this.updateStats();
                    this.render();
                },

                updateStats: function() {
                    if (!this.diagram) {
                        return;
                    }
                    var e = document.getElementById('voronoiStats');
                    if (!e) {
                        return;
                    }
                    e.innerHTML = '(' + this.diagram.cells.length + ' Voronoi cells computed from ' + this.diagram.cells.length + ' Voronoi sites in ' + this.diagram.execTime + ' ms &ndash; rendering <i>not</i> included)';
                },
                renderCellCenter: function(id, fillStyle, strokeStyle) {
                    if (id === undefined) {
                        return;
                    }
                    if (!this.diagram) {
                        return;
                    }
                    var cell = this.diagram.cells[id];
                    if (!cell) {
                        return;
                    }
                    var ctx = this.canvas.getContext('2d');
                    ctx.globalAlpha = 1;
                    // edges
                    ctx.beginPath();
                    var halfedges = cell.halfedges;
                       var nHalfedges = halfedges.length;
                       if(halfedges[0]==null){
                           return;
                       }
                        var v = halfedges[0].getStartpoint();
                        ctx.lineWidth=10;
                    ctx.moveTo(v.x+5, v.y+5);
                    for (var iHalfedge = 0; iHalfedge < nHalfedges; iHalfedge++) {
                        v = halfedges[iHalfedge].getEndpoint();
                        ctx.lineTo(v.x+5, v.y+5);
                    }
                    v = cell.site;
                    for (var i = 0; i < this.siteNumber; i++) {
                        if (this.distance2(particles[i], v) < 1) {
                            ctx.fillStyle = "hsl(" + particles[i].color + ",100%,50%)";
                        }
                    }

                    ctx.strokeStyle = strokeStyle;
                    ctx.fill();
                    ctx.stroke();
                    // site
                    v = cell.site;
                    ctx.fillStyle = '#44f';
                    
                },
                renderCellSides: function(id, fillStyle, strokeStyle) {
                    if (id === undefined) {
                        return;
                    }
                    if (!this.diagram) {
                        return;
                    }
                    var cell = this.diagram.cells[id];
                    if (!cell) {
                        return;
                    }
                    var ctx = this.canvas.getContext('2d');
                    ctx.globalAlpha = 1;
                    // edges
                    ctx.beginPath();
                    ctx.lineWidth=10;
                    var halfedges = cell.halfedges;
                       var nHalfedges = halfedges.length;
                       if(halfedges[0]==null){
                           return;
                       }
                        var v = halfedges[0].getStartpoint();
                    ctx.moveTo(v.x, v.y);
                    for (var iHalfedge = 0; iHalfedge < nHalfedges; iHalfedge++) {
                        v = halfedges[iHalfedge].getEndpoint();
                        ctx.lineTo(v.x, v.y);
                    }
                    
                    

                    ctx.strokeStyle = strokeStyle;
                    
                    ctx.stroke();
                    // site
                    v = cell.site;
                    ctx.fillStyle = '#44f';
                   
                },
                render: function() {



                    //var ctx = this.canvas.getContext('2d');
                    // background

                    ctx.clearRect(0, 0, w, h);
                    // voronoi
                    if (!this.diagram) {
                        return;
                    }

                    var cells = this.diagram.cells;
                    for (var k = 0; k < this.siteNumber*9; k++) {
                        this.renderCellCenter(k, "red", "black");
                    }
                    var cells = this.diagram.cells;
                    for (var k = 0; k < this.siteNumber*9; k++) {
                        this.renderCellSides(k, "red", "grey");
                    }
                    // edges
                    /*ctx.beginPath();
                    ctx.strokeStyle = '#000';
                    var edges = this.diagram.edges,
                        iEdge = edges.length,
                        edge, v;
                    while (iEdge--) {
                        edge = edges[iEdge];
                        v = edge.va;
                        ctx.moveTo(v.x, v.y);
                        v = edge.vb;
                        ctx.lineTo(v.x, v.y);
                    }
                    ctx.stroke();
                    // sites
                    ctx.beginPath();
                    ctx.fillStyle = '#44f';
                    var sites = this.sites,
                        iSite = sites.length;
                    while (iSite--) {
                        v = sites[iSite];
                        ctx.rect(v.x - 2 / 3, v.y - 2 / 3, 2, 2);
                    }
                    ctx.fill();*/
                },


            };














            /*var mouseX = 0;
            var mouseY = 0;
            var particles = [];

            function getCoords(event) {
                mouseX = event.clientX;
                mouseY = event.clientY;
                //document.getElementById("demo").innerHTML = coords;
            }

            function Particle(x_, y_) {
                this.x = x_;
                this.y = y_;
                this.color = Math.random() * 360;

            }


            $("body").attr("onmousemove", "getCoords(event)");


            $("body").keypress(function(e) {
                console.log(e.which);
                if (e.which == 122) {
                    particles[particles.length] = new Particle(Math.random() * w, Math.random() * h);
                    tick();
                }

            });


             //var list = $firebaseArray(ref);



            function tick() {

                //ctx.clearRect(0, 0, w, h);
                //ctx.strokeStyle="black";
                /*for (var x = 0; x < w; x += 2) {
                    for (var y = 0; y < h; y += 2) {
                        if (particles.length > 0) {
                            var closest = particles[0];
                            //var dist = Math.abs(closest.x - x) + Math.abs(closest.y - y);
                            var dist= Math.pow(closest.x - x,2) + Math.pow(closest.y - y,0);

                            for (var i = 1; i < particles.length; i++) {
                                var tempDist = Math.pow(particles[i].x - x,2) + Math.pow(particles[i].y - y,2);
                                //var tempDist = Math.abs(particles[i].x - x) + Math.abs(particles[i].y - y);
                                if (dist > tempDist) {
                                    closest = particles[i];
                                    dist = tempDist;
                                }
                            }
                            ctx.fillStyle = "hsl(" + closest.color + ",100%,50%)";
                            ctx.fillRect(x, y, 2, 2);
                            ctx.fill();
                        }
                    }
                }
                 for (var i = 1; i < particles.length; i++) {
                if (particles.length > 0) {
                            var closest = particles[j];
                            //var dist = Math.abs(closest.x - x) + Math.abs(closest.y - y);
                            var dist= Math.pow(closest.x - x,2) + Math.pow(closest.y - y,0);

                            for (var j = i; j < particles.length; j++) {
                                var tempDist = Math.pow(particles[i].x - x,2) + Math.pow(particles[i].y - y,2);
                                //var tempDist = Math.abs(particles[i].x - x) + Math.abs(particles[i].y - y);
                                if (dist > tempDist) {
                                    closest = particles[i];
                                    dist = tempDist;
                                }
                            }
                            ctx.fillStyle = "hsl(" + closest.color + ",100%,50%)";
                            ctx.fillRect(x, y, 2, 2);
                            ctx.fill();
                    }
                 }
            }

            function findPolygon(point, lines,perpLines) {
                var sortedLines=[];
                if (lines.length < 3) {
                    return [point];
                } else {
                    for(var i=0;i<lines.length;i++){
                       lines[i].distSqr=distToSegmentSquared(point,lines[i].p1,lines[i].p2);
                       var line=lines[i];
                       if(i==0){
                           sortedLines=[lines[i]];
                       }
                    }
                }
            }

            function sqr(x) {
                return x * x
            }

            function dist2(v, w) {
                return sqr(v.x - w.x) + sqr(v.y - w.y)
            }

            function distToSegmentSquared(p, v, w) {
                var l2 = dist2(v, w);

                if (l2 == 0) return dist2(p, v);

                var t = ((p.x - v.x) * (w.x - v.x) + (p.y - v.y) * (w.y - v.y)) / l2;

                if (t < 0) return dist2(p, v);
                if (t > 1) return dist2(p, w);

                return dist2(p, {
                        x: v.x + t * (w.x - v.x),
                        y: v.y + t * (w.y - v.y)
                    });
            }

            function distToSegment(p, v, w) {
                return Math.sqrt(distToSegmentSquared(p, v, w));
            }
            */
            VoronoiDemo.init();
        </script>

    </body>

</html>